<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Price Action Trader — Equity (India)</title>
<meta name="theme-color" content="#0e1420">
<style>
:root{
  --bg:#0b0f14; --fg:#e7eefb; --muted:#94a3b8; --accent:#6366f1;
  --card:#121826; --line:#263046; --pos:#16a34a; --neg:#dc2626; --warn:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);-webkit-tap-highlight-color:transparent}
header{padding:14px 12px;background:#0e1420;position:sticky;top:0;z-index:3;border-bottom:1px solid var(--line)}
header h1{margin:0;font-size:18px;line-height:1.2}
header .sub{color:var(--muted);font-size:12px;margin-top:2px}
nav{display:flex;gap:8px;overflow:auto;padding-top:10px}
nav::-webkit-scrollbar{display:none}
nav button{background:var(--card);color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-weight:700;flex:0 0 auto}
nav button.active{background:var(--accent);color:#fff;border-color:transparent}
main{padding:12px 12px 40px}
section{display:none}
section.active{display:block}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
.row{display:grid;gap:10px}
.row-2{grid-template-columns:1fr 1fr}
.row-3{grid-template-columns:1fr 1fr 1fr}
@media (max-width:640px){.row-2,.row-3{grid-template-columns:1fr}}
h2{font-size:18px;margin:4px 0 8px}
h3{font-size:16px;margin:4px 0 8px}
p{margin:8px 0;color:#d7def0}
small.muted{color:var(--muted)}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #324055;background:#0d1321;color:var(--fg);outline:none;font-size:14px}
textarea{min-height:80px}
hr{border:0;border-top:1px solid #233042;margin:14px 0}
.btn{padding:11px 12px;border:none;border-radius:12px;font-weight:800;cursor:pointer}
.btn:disabled{opacity:.6}
.btn-primary{background:var(--accent);color:#fff}
.btn-outline{background:transparent;border:1px solid #3b4a63;color:var(--fg)}
.btn-danger{background:var(--neg);color:#fff}
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media (min-width:720px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi .label{color:var(--muted);font-size:12px}
.kpi .value{font-size:22px;font-weight:900;margin-top:4px}
.kpi .pos{color:var(--pos)} .kpi .neg{color:var(--neg)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #223040;font-size:13px;text-align:left}
.badge{padding:4px 8px;border-radius:999px;background:#1f2937;color:#cbd5e1;font-size:11px}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto}
code.inline{background:#0b1220;border:1px solid #263046;padding:2px 6px;border-radius:6px}
canvas{width:100%;height:340px;background:#0d1321;border-radius:12px;border:1px solid #2a364b}
.notice{background:#111827;border:1px dashed #334155;padding:10px;border-radius:12px;color:#d1d5db}
ul{margin:8px 0 8px 16px}
li{margin:6px 0}
a.link{color:#a5b4fc;text-decoration:none;border-bottom:1px dotted #a5b4fc}
footer{color:var(--muted);font-size:12px;margin-top:20px;text-align:center}
.switch{position:relative;display:inline-block;width:48px;height:28px}
.switch input{display:none}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#374151;border-radius:28px;transition:.2s}
.slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.2s}
input:checked + .slider{background:#34d399}
input:checked + .slider:before{transform:translateX(20px)}
.help-step{margin-bottom:10px}
.help-step b{display:block;margin-bottom:4px}
.summary{color:#f3f4f6;font-weight:700}
.warning{color:#fbbf24;font-weight:700}
</style>
</head>
<body>
<header>
  <h1>Price Action Trader — Equity 🇮🇳</h1>
  <div class="sub">Short-term equity strategy • Offline • Your data stays on this device</div>
  <nav id="tabs"></nav>
</header>

<main>
  <!-- DASHBOARD -->
  <section id="dashboard" class="active">
    <div class="kpis">
      <div class="kpi"><div class="label">Trading Capital (₹)</div><div id="kpi-capital" class="value">—</div></div>
      <div class="kpi"><div class="label">Risk per Trade</div><div id="kpi-risk" class="value">—</div></div>
      <div class="kpi"><div class="label">Open Trades</div><div id="kpi-open" class="value">—</div></div>
      <div class="kpi"><div class="label">Win Rate (closed)</div><div id="kpi-winrate" class="value">—</div></div>
      <div class="kpi"><div class="label">Expectancy (R)</div><div id="kpi-exp" class="value">—</div></div>
      <div class="kpi"><div class="label">Max Drawdown</div><div id="kpi-dd" class="value">—</div></div>
      <div class="kpi"><div class="label">Closed P&L</div><div id="kpi-pnl" class="value">—</div></div>
      <div class="kpi"><div class="label">Currency</div><div id="kpi-curr" class="value">₹</div></div>
    </div>
    <div class="card">
      <div class="flex">
        <div>
          <h2 style="margin:0 0 4px">Quick Actions</h2>
          <small class="muted">Maintain strict risk; journal every trade.</small>
        </div>
        <div class="right">
          <button class="btn btn-outline" onclick="go('journal')">Add Trade</button>
          <button class="btn btn-primary" onclick="go('scanner')">Analyze OHLC</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Today’s Checklist</h3>
      <div id="today-checklist" class="row row-2"></div>
      <div class="flex" style="margin-top:8px">
        <button class="btn btn-primary" onclick="saveChecklist()">Save</button>
        <button class="btn btn-outline" onclick="resetChecklist()">Reset</button>
        <div class="right"><small class="muted">Find it in <b>Strategy → Checklist</b></small></div>
      </div>
    </div>
  </section>

  <!-- STRATEGY -->
  <section id="strategy">
    <div class="card">
      <h2 style="margin-top:0">Core Strategy: Trend Breakout + Retest (Equity)</h2>
      <ol>
        <li><b>Market Filter</b>: Trade in the direction of the <b>Daily</b> trend (HH/HL uptrend, LH/LL downtrend).</li>
        <li><b>Setup</b>: On the <b>1H or 15M</b> chart, price consolidates below a clear resistance (supply) or above support (demand).</li>
        <li><b>Trigger</b>: A strong <b>breakout candle</b> closes beyond the level. Prefer volume &gt; 1.5× 20‑bar average.</li>
        <li><b>Entry</b>: On a <b>retest</b> of the breakout level, wait for a bullish/bearish confirmation candle and enter.</li>
        <li><b>Stop‑loss</b>: A few ticks beyond the invalidation (last swing low/high) or 1× ATR(14), whichever is wider.</li>
        <li><b>Targets</b>: First target at 2R; trail remainder behind swing lows/highs or ATR multiple.</li>
        <li><b>Risk</b>: Risk ≤ <b>1% of capital</b> per trade. Max 3 open positions.</li>
      </ol>
      <div class="notice">
        <b>Note:</b> This app does <u>not</u> fetch market data. Paste OHLC in the Scanner to evaluate signals. Nothing here is investment advice.
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Strategy Checklist</h3>
      <div id="checklist" class="row row-2"></div>
      <div class="flex" style="margin-top:8px">
        <button class="btn btn-primary" onclick="saveChecklist()">Save</button>
        <button class="btn btn-outline" onclick="resetChecklist()">Reset to Defaults</button>
      </div>
    </div>
  </section>

  <!-- JOURNAL -->
  <section id="journal">
    <div class="card">
      <h2 style="margin-top:0">New Equity Trade</h2>
      <div class="row row-2">
        <div>
          <label>Symbol (e.g., RELIANCE, TCS)</label>
          <input id="t-symbol" placeholder="Symbol">
        </div>
        <div>
          <label>Direction</label>
          <select id="t-dir"><option>LONG</option><option>SHORT</option></select>
        </div>
        <div>
          <label>Entry Price</label>
          <input id="t-entry" type="number" step="0.01" placeholder="e.g., 2510.50">
        </div>
        <div>
          <label>Stop-loss</label>
          <input id="t-stop" type="number" step="0.01" placeholder="e.g., 2480.00">
        </div>
        <div>
          <label>Target</label>
          <input id="t-target" type="number" step="0.01" placeholder="Optional">
        </div>
        <div>
          <label>Quantity (auto if blank)</label>
          <input id="t-qty" type="number" step="1" placeholder="Leave empty to auto-calc">
        </div>
        <div class="row" style="grid-column:1 / -1">
          <label>Notes</label>
          <textarea id="t-notes" placeholder="Why this trade? Breakout level, pattern, checklist items..."></textarea>
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn btn-primary" onclick="createTrade()">Add Trade</button>
        <button class="btn btn-outline" onclick="go('position')">Position Size</button>
        <div class="right"><small class="muted">Risk &amp; qty auto-calc from your settings.</small></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Open Positions</h3>
      <div id="open-trades"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Closed Positions</h3>
      <div id="closed-trades"></div>
    </div>
  </section>

  <!-- SCANNER -->
  <section id="scanner">
    <div class="card">
      <h2 style="margin-top:0">OHLC Analyzer (Paste CSV)</h2>
      <p>Paste recent OHLC data (with headers). Columns accepted: <code class="inline">Date,Open,High,Low,Close,Volume</code>. Latest row last or first—auto‑handled.</p>
      <textarea id="csv-input" placeholder="Date,Open,High,Low,Close,Volume
2025-07-01,2540,2562,2531,2555,12345678
2025-07-02,2556,2575,2548,2570,11876543"></textarea>
      <div class="flex" style="margin-top:10px">
        <button class="btn btn-primary" onclick="analyzeCSV()">Parse & Analyze</button>
        <button class="btn btn-outline" onclick="clearCSV()">Clear</button>
        <div class="right"><small class="muted">Analysis uses 20‑bar breakout & ATR(14).</small></div>
      </div>
    </div>

    <div id="scan-results" class="card" style="display:none">
      <h3 style="margin-top:0">Signals</h3>
      <div id="signals"></div>
      <hr>
      <canvas id="chart"></canvas>
    </div>
  </section>

  <!-- POSITION SIZING & SETTINGS -->
  <section id="position">
    <div class="card">
      <h2 style="margin-top:0">Account & Risk</h2>
      <div class="row row-2">
        <div><label>Trading Capital (₹)</label><input id="s-capital" type="number" step="0.01"></div>
        <div><label>Risk per Trade (%)</label><input id="s-riskpct" type="number" step="0.1"></div>
        <div><label>Brokerage + Taxes (%)</label><input id="s-fees" type="number" step="0.01"></div>
        <div><label>Slippage (%)</label><input id="s-slip" type="number" step="0.01"></div>
        <div><label>Currency Symbol</label><input id="s-curr" placeholder="₹"></div>
        <div><label>Max Concurrent Positions</label><input id="s-maxopen" type="number" step="1"></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn btn-primary" onclick="saveSettings()">Save</button>
        <button class="btn btn-outline" onclick="resetSettings()">Defaults</button>
        <div class="right"><small class="muted">These values drive position sizing and KPIs.</small></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Position Sizing Calculator</h3>
      <div class="row row-2">
        <div><label>Direction</label><select id="pc-dir"><option>LONG</option><option>SHORT</option></select></div>
        <div><label>Entry</label><input id="pc-entry" type="number" step="0.01"></div>
        <div><label>Stop-loss</label><input id="pc-stop" type="number" step="0.01"></div>
        <div><label>Target (optional)</label><input id="pc-target" type="number" step="0.01"></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn btn-primary" onclick="calcPosition()">Calculate</button>
        <button class="btn btn-outline" onclick="clearPosition()">Clear</button>
      </div>
      <div id="pc-result" class="notice" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- BACKUP -->
  <section id="backup">
    <div class="card">
      <h2 style="margin-top:0">Backup & Data</h2>
      <div class="row row-2">
        <div class="notice">
          <b>Your data lives only on this device</b> using browser storage. Export regularly if you clear cache or switch phones.
        </div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn btn-primary" onclick="exportData()">Export JSON</button>
        <label class="btn btn-outline" for="import-file">Import JSON</label>
        <input id="import-file" type="file" accept="application/json" style="display:none">
        <button class="btn btn-danger right" onclick="resetAll()">Wipe All Data</button>
      </div>
    </div>
  </section>

  <!-- HELP -->
  <section id="help">
    <div class="card">
      <h2 style="margin-top:0">How to Use (Equity — Intraday/Swing)</h2>
      <div class="help-step"><b>1) Scan stocks</b> — In your charting app, mark equities making HH/HL or near key levels. Paste OHLC here to check trend, 20‑bar breakout, ATR and volume.</div>
      <div class="help-step"><b>2) Plan</b> — Use <b>Position Size</b> to compute quantity from entry/stop. Risk ≤ 1%.</div>
      <div class="help-step"><b>3) Execute on retest</b> — Wait for a confirmation candle. Avoid chasing.</div>
      <div class="help-step"><b>4) Manage</b> — First target at 2R. Then trail below swing lows/highs or 1×ATR.</div>
      <div class="help-step"><b>5) Journal</b> — Record entry, stop, reasoning and screenshot link (in notes). Review weekly.</div>
      <div class="notice"><span class="warning">Disclaimer:</span> Trading involves substantial risk. There are no assured monthly returns. This tool is educational only.</div>
    </div>
    <footer>v1.1 • Equity‑only • Built for offline use • © You</footer>
  </section>
</main>

<script>
(function(){
  const STORAGE_KEY = 'pa_trader_equity_v1';
  const DEFAULTS = {
    capital: 100000,
    riskPct: 1.0,
    feesPct: 0.03,
    slipPct: 0.02,
    currency: '₹',
    maxOpen: 3,
    trades: [],
    checklist: [
      {id:'d-trend', text:'Daily trend aligns with trade direction', checked:false},
      {id:'level-clear', text:'Clean level with multiple touches (S/R)', checked:false},
      {id:'consolidation', text:'Tight consolidation before breakout', checked:false},
      {id:'breakout-close', text:'Breakout candle closes beyond level', checked:false},
      {id:'retest', text:'Price retests level; confirmation candle', checked:false},
      {id:'vol', text:'Volume ≥ 1.5× 20-bar average', checked:false},
      {id:'sl', text:'Stop set beyond invalidation / ≥ 1×ATR', checked:false},
      {id:'rr', text:'Reward ≥ 2R to first target', checked:false},
      {id:'size', text:'Position size ≤ 1% risk', checked:false},
      {id:'news', text:'No major event in next 24h', checked:false}
    ]
  };

  // -------- Storage --------
  let state = load();
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ return JSON.parse(JSON.stringify(DEFAULTS)); }
      const obj = JSON.parse(raw);
      for(const k in DEFAULTS){
        if(!(k in obj)) obj[k] = DEFAULTS[k];
      }
      return obj;
    }catch(e){
      console.error('load', e);
      return JSON.parse(JSON.stringify(DEFAULTS));
    }
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    renderAll();
  }
  function fmt(n){
    if(n===null||n===undefined||isNaN(n)) return '—';
    return (state.currency||'₹') + ' ' + Number(n).toLocaleString(undefined,{maximumFractionDigits:2});
  }
  function f2(n){
    if(n===null||n===undefined||isNaN(n)) return '—';
    return Number(n).toLocaleString(undefined,{maximumFractionDigits:2});
  }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

  // -------- Nav --------
  const tabs = [
    {id:'dashboard', label:'Dashboard'},
    {id:'strategy', label:'Strategy'},
    {id:'journal', label:'Journal'},
    {id:'scanner', label:'Scanner'},
    {id:'position', label:'Position Size'},
    {id:'backup', label:'Backup'},
    {id:'help', label:'Help'}
  ];
  const tabEl = document.getElementById('tabs');
  tabs.forEach(t=>{
    const b=document.createElement('button'); b.textContent=t.label; b.onclick=()=>go(t.id); b.id='tab-'+t.id;
    tabEl.appendChild(b);
  });
  window.go = function(id){
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    if(id==='scanner'){ setTimeout(()=>resizeChart(),0); }
  }

  // -------- Checklist --------
  function renderChecklist(){
    const cont = document.getElementById('checklist');
    cont.innerHTML='';
    state.checklist.forEach(item=>{
      const wrap=document.createElement('div');
      wrap.className='card';
      wrap.style.margin='0';
      wrap.innerHTML=`<div class="flex"><div><b>${item.text}</b></div>
        <div class="right">
          <label class="switch">
            <input type="checkbox" id="cl-${item.id}" ${item.checked?'checked':''}>
            <span class="slider"></span>
          </label>
        </div></div>`;
      cont.appendChild(wrap);
    });

    const tcont = document.getElementById('today-checklist');
    if(tcont){
      tcont.innerHTML='';
      state.checklist.forEach(item=>{
        const wrap=document.createElement('div'); wrap.className='card'; wrap.style.margin='0';
        wrap.innerHTML=`<div class="flex"><div>${item.text}</div>
          <div class="right">
          <label class="switch">
            <input type="checkbox" id="tod-${item.id}" ${item.checked?'checked':''}>
            <span class="slider"></span>
          </label></div></div>`;
        tcont.appendChild(wrap);
      });
    }
  }
  window.saveChecklist = function(){
    const next = state.checklist.map(item=>{
      const el = document.getElementById('cl-'+item.id) || document.getElementById('tod-'+item.id);
      return {...item, checked: !!(el && el.checked)};
    });
    state.checklist = next;
    save();
  }
  window.resetChecklist = function(){
    state.checklist = JSON.parse(JSON.stringify(DEFAULTS.checklist));
    save();
  }

  // -------- Settings & Position Sizing --------
  const sEls = {
    capital: document.getElementById('s-capital'),
    riskpct: document.getElementById('s-riskpct'),
    fees: document.getElementById('s-fees'),
    slip: document.getElementById('s-slip'),
    curr: document.getElementById('s-curr'),
    maxopen: document.getElementById('s-maxopen')
  };
  function renderSettings(){
    sEls.capital.value = state.capital;
    sEls.riskpct.value = state.riskPct;
    sEls.fees.value = state.feesPct;
    sEls.slip.value = state.slipPct;
    sEls.curr.value = state.currency || '₹';
    sEls.maxopen.value = state.maxOpen;
  }
  window.saveSettings = function(){
    state.capital = +sEls.capital.value||0;
    state.riskPct = +sEls.riskpct.value||0;
    state.feesPct = +sEls.fees.value||0;
    state.slipPct = +sEls.slip.value||0;
    state.currency = sEls.curr.value||'₹';
    state.maxOpen = parseInt(sEls.maxopen.value||'3',10);
    save();
    alert('Saved.');
  }
  window.resetSettings = function(){
    state.capital = DEFAULTS.capital;
    state.riskPct = DEFAULTS.riskPct;
    state.feesPct = DEFAULTS.feesPct;
    state.slipPct = DEFAULTS.slipPct;
    state.currency = DEFAULTS.currency;
    state.maxOpen = DEFAULTS.maxOpen;
    save();
  }

  // Position sizing calculator
  window.calcPosition = function(){
    const dir = document.getElementById('pc-dir').value;
    const entry = +document.getElementById('pc-entry').value;
    const stop = +document.getElementById('pc-stop').value;
    const target = +document.getElementById('pc-target').value || null;
    const res = computePosition(entry, stop, target);
    const el = document.getElementById('pc-result');
    if(!res.ok){
      el.innerHTML = '<b class="warning">Check inputs:</b> entry and stop must be numbers and not equal.';
      return;
    }
    el.innerHTML = `
      <div class="row row-2">
        <div><b>Risk per trade:</b><br>${fmt(res.riskAmt)}</div>
        <div><b>Risk per share:</b><br>${f2(res.riskPerShare)}</div>
        <div><b>Suggested Qty:</b><br>${res.qty}</div>
        <div><b>Total exposure:</b><br>${fmt(res.exposure)}</div>
        <div><b>Est. fees:</b><br>${fmt(res.fees)}</div>
        <div><b>Slippage buffer:</b><br>${fmt(res.slip)}</div>
        <div><b>Break-even move:</b><br>${f2(res.beMove)} pts</div>
        <div><b>Reward:Risk @ target:</b><br>${res.rrText}</div>
      </div>`;
  }
  window.clearPosition = function(){
    ['pc-entry','pc-stop','pc-target'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('pc-result').innerHTML='';
  }
  function computePosition(entry, stop, target){
    if(!isFinite(entry) || !isFinite(stop) || entry===stop){ return {ok:false}; }
    const riskAmt = state.capital * (state.riskPct/100);
    const riskPerShare = Math.abs(entry - stop);
    let qty = Math.floor(riskAmt / riskPerShare);
    if(qty<1) qty=1;
    const exposure = qty * entry;
    const fees = exposure * (state.feesPct/100);
    const slip = entry * (state.slipPct/100) * qty;
    const beMove = (fees + slip) / qty;
    let rrText = '—';
    if(isFinite(target)){
      const rewardPer = Math.abs(target - entry);
      const rr = rewardPer / riskPerShare;
      rrText = rr.toFixed(2)+' R';
    }
    return {ok:true, riskAmt, riskPerShare, qty, exposure, fees, slip, beMove, rrText};
  }

  // -------- Journal (trades) --------
  function renderTrades(){
    const open = state.trades.filter(t=>t.status==='OPEN').sort((a,b)=>b.openTs-a.openTs);
    const closed = state.trades.filter(t=>t.status==='CLOSED').sort((a,b)=>b.closeTs-a.closeTs);

    // Open trades table
    const ot = document.createElement('table');
    ot.innerHTML = `<thead><tr>
      <th>Symbol</th><th>Dir</th><th>Entry</th><th>Stop</th><th>Qty</th><th>R (init)</th><th>Opened</th><th></th>
    </tr></thead>`;
    const ob = document.createElement('tbody');
    open.forEach(t=>{
      const r=document.createElement('tr');
      const initRisk = Math.abs(t.entry - t.stop) * t.qty;
      r.innerHTML = `
        <td><b>${t.symbol}</b></td>
        <td>${t.direction}</td>
        <td>${f2(t.entry)}</td>
        <td>${f2(t.stop)}</td>
        <td>${t.qty}</td>
        <td>${fmt(initRisk)}</td>
        <td>${new Date(t.openTs).toLocaleString()}</td>
        <td><button class="btn btn-outline" onclick="closeTradePrompt('${t.id}')">Close</button></td>`;
      ob.appendChild(r);
    });
    ot.appendChild(ob);
    const openWrap = document.getElementById('open-trades');
    openWrap.innerHTML='';
    openWrap.appendChild(ot);
    if(open.length===0){ openWrap.innerHTML='<small class="muted">No open positions.</small>'; }

    // Closed trades table
    const ct = document.createElement('table');
    ct.innerHTML = `<thead><tr>
      <th>Symbol</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Qty</th><th>P&amp;L</th><th>R</th><th>Closed</th>
    </tr></thead>`;
    const cb = document.createElement('tbody');
    closed.forEach(t=>{
      const r=document.createElement('tr');
      const rVal = (t.rMultiple!==undefined) ? t.rMultiple.toFixed(2) : '—';
      const pnlCls = (t.pnl||0)>=0 ? 'pos' : 'neg';
      r.innerHTML = `
        <td><b>${t.symbol}</b></td>
        <td>${t.direction}</td>
        <td>${f2(t.entry)}</td>
        <td>${f2(t.exit)}</td>
        <td>${t.qty}</td>
        <td class="${pnlCls}">${fmt(t.pnl)}</td>
        <td>${rVal}</td>
        <td>${new Date(t.closeTs).toLocaleString()}</td>`;
      cb.appendChild(r);
    });
    ct.appendChild(cb);
    const closedWrap = document.getElementById('closed-trades');
    closedWrap.innerHTML='';
    closedWrap.appendChild(ct);
    if(closed.length===0){ closedWrap.innerHTML='<small class="muted">No closed positions.</small>'; }
  }

  window.createTrade = function(){
    const symbol = document.getElementById('t-symbol').value.trim().toUpperCase();
    const direction = document.getElementById('t-dir').value;
    const entry = +document.getElementById('t-entry').value;
    const stop = +document.getElementById('t-stop').value;
    const target = +document.getElementById('t-target').value || null;
    let qty = parseInt(document.getElementById('t-qty').value||'0',10);
    const notes = document.getElementById('t-notes').value.trim();

    if(!symbol || !isFinite(entry) || !isFinite(stop)){ alert('Symbol, entry and stop are required.'); return; }
    if(qty<=0){
      const pos = computePosition(entry, stop, target);
      if(!pos.ok){ alert('Unable to auto-calc quantity. Provide qty.'); return; }
      qty = pos.qty;
    }

    const trade = {
      id: uid(), symbol, direction,
      entry, stop, target, qty, notes,
      openTs: Date.now(), status:'OPEN'
    };
    state.trades.push(trade);
    save();
    ['t-symbol','t-entry','t-stop','t-target','t-qty','t-notes'].forEach(id=>document.getElementById(id).value='');
    alert('Position added.');
  }

  window.closeTradePrompt = function(id){
    const t = state.trades.find(x=>x.id===id);
    if(!t) return;
    const price = prompt(`Exit price for ${t.symbol} (${t.direction})?`);
    if(price===null) return;
    const exit = +price;
    if(!isFinite(exit)){ alert('Invalid price'); return; }
    closeTrade(t, exit);
  }
  function closeTrade(t, exit){
    const riskPer = Math.abs(t.entry - t.stop);
    let pnl = (t.direction==='LONG' ? (exit - t.entry) : (t.entry - exit)) * t.qty;
    const fees = (t.entry * t.qty + exit * t.qty) * (state.feesPct/100);
    const slip = (t.entry + exit) * (state.slipPct/100) * t.qty;
    pnl -= (fees + slip);
    t.exit = exit;
    t.pnl = pnl;
    t.rMultiple = riskPer>0 ? ( (t.direction==='LONG' ? (exit - t.entry) : (t.entry - exit)) / riskPer ) : 0;
    t.status = 'CLOSED';
    t.closeTs = Date.now();
    save();
  }

  // -------- KPIs --------
  function renderKPIs(){
    const closed = state.trades.filter(t=>t.status==='CLOSED');
    const open = state.trades.filter(t=>t.status==='OPEN');
    const kCapital = document.getElementById('kpi-capital');
    kCapital.textContent = fmt(state.capital);
    document.getElementById('kpi-risk').textContent = f2(state.riskPct)+' %';
    document.getElementById('kpi-open').textContent = open.length;
    document.getElementById('kpi-curr').textContent = state.currency||'₹';

    let wins=0, losses=0, pnl=0, rWins=[], rLosses=[];
    let equity= [0];
    closed.forEach(t=>{
      pnl += (t.pnl||0);
      if((t.pnl||0)>=0){ wins++; rWins.push(t.rMultiple||0); } else { losses++; rLosses.push(t.rMultiple||0); }
      equity.push(pnl);
    });
    const total = wins+losses;
    const winrate = total? (wins/total*100):0;
    document.getElementById('kpi-winrate').textContent = f2(winrate)+' %';
    document.getElementById('kpi-pnl').textContent = fmt(pnl);

    function maxDrawdown(arr){
      let max=arr[0], dd=0;
      for(let i=1;i<arr.length;i++){
        if(arr[i]>max) max=arr[i];
        dd = Math.min(dd, arr[i]-max);
      }
      return Math.abs(dd);
    }
    document.getElementById('kpi-dd').textContent = fmt(maxDrawdown(equity));

    const avg = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0;
    const avgWin = avg(rWins), avgLoss = Math.abs(avg(rLosses));
    const expR = avgWin * (winrate/100) - avgLoss * (1 - winrate/100);
    document.getElementById('kpi-exp').textContent = f2(expR);
  }

  // -------- Scanner --------
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/).filter(x=>x.trim().length>0);
    if(lines.length<2) return [];
    const head = lines[0].split(',').map(x=>x.trim().toLowerCase());
    const idx = {
      date: head.findIndex(h=>/date/i.test(h)),
      open: head.findIndex(h=>/open/i.test(h)),
      high: head.findIndex(h=>/high/i.test(h)),
      low:  head.findIndex(h=>/low/i.test(h)),
      close:head.findIndex(h=>/close/i.test(h)),
      volume:head.findIndex(h=>/vol/i.test(h))
    };
    const data = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(',').map(x=>x.trim());
      const item = {
        date: idx.date>=0 ? cols[idx.date] : (i+''),
        open: +cols[idx.open],
        high: +cols[idx.high],
        low:  +cols[idx.low],
        close:+cols[idx.close],
        volume: idx.volume>=0 ? +cols[idx.volume] : 0
      };
      if([item.open,item.high,item.low,item.close].every(v=>isFinite(v))) data.push(item);
    }
    const asc = new Date(data[0].date).getTime() <= new Date(data[data.length-1].date).getTime();
    return asc ? data : data.reverse();
  }

  function sma(arr, period){
    const out=[]; let sum=0;
    for(let i=0;i<arr.length;i++){
      sum += arr[i];
      if(i>=period) sum -= arr[i-period];
      out.push(i>=period-1 ? sum/period : NaN);
    }
    return out;
  }
  function atr14(data){
    const trs = data.map((d,i)=>{
      const prev = i>0 ? data[i-1] : d;
      const tr = Math.max(d.high - d.low, Math.abs(d.high - prev.close), Math.abs(d.low - prev.close));
      return tr;
    });
    return sma(trs, 14);
  }
  function rollingMax(arr, period, accessor){
    const out=[]; let dq=[];
    for(let i=0;i<arr.length;i++){
      const val = accessor(arr[i]);
      while(dq.length && dq[dq.length-1].val <= val) dq.pop();
      dq.push({i,val});
      while(dq.length && dq[0].i <= i-period) dq.shift();
      out.push(dq[0].val);
    }
    return out;
  }
  function rollingMin(arr, period, accessor){
    const out=[]; let dq=[];
    for(let i=0;i<arr.length;i++){
      const val = accessor(arr[i]);
      while(dq.length && dq[dq.length-1].val >= val) dq.pop();
      dq.push({i,val});
      while(dq.length && dq[0].i <= i-period) dq.shift();
      out.push(dq[0].val);
    }
    return out;
  }
  function detectTrend(data){
    const closes = data.map(d=>d.close);
    const ma20 = sma(closes,20);
    const n = data.length-1;
    const slope = ma20[n]-ma20[n-5];
    if(!isFinite(ma20[n])||!isFinite(slope)) return 'Unknown';
    if(closes[n]>ma20[n] && slope>0) return 'Uptrend';
    if(closes[n]<ma20[n] && slope<0) return 'Downtrend';
    return 'Range/Neutral';
  }
  function analyze(data){
    if(data.length<25) return {ok:false, msg:'Need at least 25 rows of data.'};
    const n = data.length-1;
    const vols  = data.map(d=>d.volume||0);
    const atr = atr14(data);
    const maVol = sma(vols, 20);
    const max20 = rollingMax(data, 20, d=>d.high);
    const min20 = rollingMin(data, 20, d=>d.low);
    const prevHigh20 = max20[n-1];
    const prevLow20  = min20[n-1];
    const breakoutUp = data[n].close > prevHigh20;
    const breakoutDn = data[n].close < prevLow20;
    const volExp = isFinite(maVol[n]) ? vols[n] > 1.5 * maVol[n] : false;
    const atrVal = atr[n];
    const trend = detectTrend(data);
    let retest=false;
    for(let i=Math.max(0,n-3); i<=n; i++){
      if(breakoutUp && Math.abs(data[i].low - prevHigh20) <= (0.2*(atr[i]||atrVal||0))) retest = true;
      if(breakoutDn && Math.abs(data[i].high - prevLow20)  <= (0.2*(atr[i]||atrVal||0))) retest = true;
    }
    return {ok:true, trend, breakoutUp, breakoutDn, volExp, prevHigh20, prevLow20, atr: atrVal, last: data[n], data};
  }

  // Chart
  let chartCanvas = document.getElementById('chart');
  function resizeChart(){
    if(!chartCanvas) chartCanvas = document.getElementById('chart');
    if(!chartCanvas) return;
    const dpr = window.devicePixelRatio||1;
    const w = chartCanvas.clientWidth;
    const h = chartCanvas.clientHeight;
    chartCanvas.width = Math.floor(w*dpr);
    chartCanvas.height= Math.floor(h*dpr);
    const ctx = chartCanvas.getContext('2d');
    ctx.scale(dpr, dpr);
  }
  function drawChart(data){
    if(!chartCanvas) return;
    const ctx = chartCanvas.getContext('2d');
    const W = chartCanvas.clientWidth;
    const H = chartCanvas.clientHeight;
    ctx.clearRect(0,0,W,H);
    const view = data.slice(-100);
    const highs = view.map(d=>d.high), lows=view.map(d=>d.low);
    const maxH = Math.max(...highs), minL = Math.min(...lows);
    const pad = 8;
    const y = v => pad + (H-2*pad) * (1 - (v - minL)/(maxH - minL || 1));
    const xStep = (W-2*pad) / (view.length);
    // grid
    ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 1;
    for(let i=0;i<5;i++){
      const yy = pad + (H-2*pad) * i/4;
      ctx.beginPath(); ctx.moveTo(pad, yy); ctx.lineTo(W-pad, yy); ctx.stroke();
    }
    // candles
    for(let i=0;i<view.length;i++){
      const d=view[i];
      const x = pad + i*xStep + xStep*0.5;
      const up = d.close>=d.open;
      ctx.strokeStyle = up ? '#10b981' : '#ef4444';
      ctx.fillStyle   = up ? '#10b981' : '#ef4444';
      // wick
      ctx.beginPath(); ctx.moveTo(x, y(d.high)); ctx.lineTo(x, y(d.low)); ctx.stroke();
      // body
      const bw = Math.max(2, xStep*0.6);
      const top = y(Math.max(d.open,d.close)); const bot = y(Math.min(d.open,d.close));
      const h = Math.max(1, bot-top);
      ctx.fillRect(x-bw/2, top, bw, h);
    }
  }

  window.analyzeCSV = function(){
    const raw = document.getElementById('csv-input').value;
    const data = parseCSV(raw);
    const res = analyze(data);
    const box = document.getElementById('scan-results');
    const out = document.getElementById('signals');
    if(!res.ok){ box.style.display='block'; out.innerHTML = '<b class="warning">'+(res.msg||'Invalid data.')+'</b>'; return; }

    const bullets = [];
    bullets.push(`<div class="summary">Trend: ${res.trend}</div>`);
    if(res.breakoutUp)  bullets.push(`✅ <b>Upside breakout</b> above prior 20‑bar high (${f2(res.prevHigh20)}).`);
    if(res.breakoutDn)  bullets.push(`✅ <b>Downside breakout</b> below prior 20‑bar low (${f2(res.prevLow20)}).`);
    if(!res.breakoutUp && !res.breakoutDn) bullets.push('ℹ️ No 20‑bar breakout on the latest bar.');
    bullets.push(`ATR(14): <b>${f2(res.atr)}</b>`);
    bullets.push(`Volume Expansion: <b>${res.volExp ? 'Yes (≥1.5× avg)' : 'No'}</b>`);
    out.innerHTML = '<ul><li>'+bullets.join('</li><li>')+'</li></ul>';

    document.getElementById('scan-results').style.display='block';
    resizeChart();
    drawChart(res.data);
  }
  window.clearCSV = function(){ document.getElementById('csv-input').value=''; document.getElementById('scan-results').style.display='none'; }

  // -------- Export / Import / Reset --------
  window.exportData = function(){
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='pa_trader_equity_backup.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  document.getElementById('import-file').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        const obj = JSON.parse(ev.target.result);
        if(!obj || typeof obj!=='object'){ alert('Invalid file.'); return; }
        if(!('trades' in obj) || !('capital' in obj)){ alert('Unexpected data.'); return; }
        state = {...state, ...obj};
        save();
        alert('Import successful.');
      }catch(err){ alert('Import failed: '+err.message); }
    };
    reader.readAsText(file);
  });
  window.resetAll = function(){
    if(confirm('This will erase all positions & settings. Continue?')){
      state = JSON.parse(JSON.stringify(DEFAULTS));
      save();
      alert('All data cleared.');
    }
  }

  function renderAll(){
    const current = document.querySelector('section.active')?.id || 'dashboard';
    renderChecklist();
    renderSettings();
    renderTrades();
    renderKPIs();
    go(current);
  }
  window.addEventListener('resize', resizeChart);
  renderAll();
  go('dashboard');

})();</script>
</body>
</html>
