<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Price Action Trader — Equity (Auto‑Data)</title>
<meta name="theme-color" content="#0e1420" />
<style>
:root{
  --bg:#0b0f14; --fg:#e7eefb; --muted:#94a3b8; --accent:#6366f1;
  --card:#121826; --line:#263046; --pos:#16a34a; --neg:#dc2626; --warn:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);-webkit-tap-highlight-color:transparent}
header{padding:14px 12px;background:#0e1420;position:sticky;top:0;z-index:3;border-bottom:1px solid var(--line)}
header h1{margin:0;font-size:18px;line-height:1.2}
header .sub{color:var(--muted);font-size:12px;margin-top:2px}
nav{display:flex;gap:8px;overflow:auto;padding-top:10px}
nav::-webkit-scrollbar{display:none}
nav button{background:var(--card);color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-weight:700;flex:0 0 auto;cursor:pointer}
nav button.active{background:var(--accent);color:#fff;border-color:transparent}
main{padding:12px 12px 40px}
section{display:none}
section.active{display:block}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
.row{display:grid;gap:10px}
.row-2{grid-template-columns:1fr 1fr}
.row-3{grid-template-columns:1fr 1fr 1fr}
@media (max-width:640px){.row-2,.row-3{grid-template-columns:1fr}}
h2{font-size:18px;margin:4px 0 8px}
h3{font-size:16px;margin:4px 0 8px}
p{margin:8px 0;color:#d7def0}
small.muted{color:var(--muted)}
label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #324055;background:#0d1321;color:var(--fg);outline:none;font-size:14px}
textarea{min-height:80px}
hr{border:0;border-top:1px solid #233042;margin:14px 0}
.btn{padding:11px 12px;border:none;border-radius:12px;font-weight:800;cursor:pointer}
.btn:disabled{opacity:.6}
.btn-primary{background:var(--accent);color:#fff}
.btn-outline{background:transparent;border:1px solid #3b4a63;color:var(--fg)}
.btn-danger{background:var(--neg);color:#fff}
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media (min-width:720px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi .label{color:var(--muted);font-size:12px}
.kpi .value{font-size:22px;font-weight:900;margin-top:4px}
.kpi .pos{color:var(--pos)} .kpi .neg{color:var(--neg)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #223040;font-size:13px;text-align:left}
.badge{padding:4px 8px;border-radius:999px;background:#1f2937;color:#cbd5e1;font-size:11px}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto}
code.inline{background:#0b1220;border:1px solid #263046;padding:2px 6px;border-radius:6px}
canvas{width:100%;height:340px;background:#0d1321;border-radius:12px;border:1px solid #2a364b}
.notice{background:#111827;border:1px dashed #334155;padding:10px;border-radius:12px;color:#d1d5db}
ul{margin:8px 0 8px 16px}
li{margin:6px 0}
a.link{color:#a5b4fc;text-decoration:none;border-bottom:1px dotted #a5b4fc}
footer{color:var(--muted);font-size:12px;margin-top:20px;text-align:center}
.switch{position:relative;display:inline-block;width:48px;height:28px}
.switch input{display:none}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#374151;border-radius:28px;transition:.2s}
.slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.2s}
input:checked + .slider{background:#34d399}
input:checked + .slider:before{transform:translateX(20px)}
.help-step{margin-bottom:10px}
.help-step b{display:block;margin-bottom:4px}
.summary{color:#f3f4f6;font-weight:700}
.warning{color:#fbbf24;font-weight:700}
.small{font-size:12px}
.spinner{border:3px solid #334155;border-top:3px solid #a5b4fc;border-radius:50%;width:18px;height:18px;animation:spin 0.8s linear infinite}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
kbd{background:#0b1220;color:#e5e7eb;border:1px solid #263046;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<header>
  <h1>Price Action Trader — Equity (Auto‑Data) 🇮🇳</h1>
  <div class="sub">Short‑term equity strategy • Auto data fetch • Offline journal</div>
  <nav id="tabs"></nav>
</header>

<main>
  <!-- DASHBOARD -->
  <section id="dashboard" class="active">
    <div class="kpis">
      <div class="kpi"><div class="label">Trading Capital (₹)</div><div id="kpi-capital" class="value">—</div></div>
      <div class="kpi"><div class="label">Risk per Trade</div><div id="kpi-risk" class="value">—</div></div>
      <div class="kpi"><div class="label">Open Positions</div><div id="kpi-open" class="value">—</div></div>
      <div class="kpi"><div class="label">Win Rate (closed)</div><div id="kpi-winrate" class="value">—</div></div>
      <div class="kpi"><div class="label">Expectancy (R)</div><div id="kpi-exp" class="value">—</div></div>
      <div class="kpi"><div class="label">Max Drawdown</div><div id="kpi-dd" class="value">—</div></div>
      <div class="kpi"><div class="label">Closed P&L</div><div id="kpi-pnl" class="value">—</div></div>
      <div class="kpi"><div class="label">Currency</div><div id="kpi-curr" class="value">₹</div></div>
    </div>
    <div class="card">
      <div class="flex">
        <div>
          <h2 style="margin:0 0 4px">Quick Actions</h2>
          <small class="muted">Fetch data → analyze → size → execute → journal.</small>
        </div>
        <div class="right">
          <button class="btn btn-primary" onclick="go('data')">Fetch Data</button>
          <button class="btn btn-outline" onclick="go('journal')">Add Trade</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Today’s Checklist</h3>
      <div id="today-checklist" class="row row-2"></div>
      <div class="flex" style="margin-top:8px">
        <button class="btn btn-primary" onclick="saveChecklist()">Save</button>
        <button class="btn btn-outline" onclick="resetChecklist()">Reset</button>
        <div class="right"><small class="muted">Find it in <b>Strategy → Checklist</b></small></div>
      </div>
    </div>
  </section>

  <!-- DATA (auto fetch) -->
  <section id="data">
    <div class="card">
      <h2 style="margin-top:0">Market Data (Auto Fetch)</h2>
      <div class="row row-2">
        <div>
          <label>Provider</label>
          <select id="d-provider">
            <option value="AUTO">AUTO (Yahoo → Alpha Vantage)</option>
            <option value="YF">Yahoo Finance (no key)</option>
            <option value="AV">Alpha Vantage (API key)</option>
          </select>
        </div>
        <div>
          <label>Exchange</label>
          <select id="d-exch">
            <option value="NS">NSE (.NS)</option>
            <option value="BO">BSE (.BO)</option>
          </select>
        </div>
        <div>
          <label>Symbol</label>
          <input id="d-symbol" placeholder="e.g., RELIANCE, TCS, HDFCBANK" />
        </div>
        <div>
          <label>Interval</label>
          <select id="d-interval">
            <option value="1d">Daily</option>
            <option value="60m">60 min</option>
            <option value="15m">15 min</option>
          </select>
        </div>
        <div>
          <label>Range / Size</label>
          <select id="d-range">
            <option value="3mo">3 months (YF)</option>
            <option value="6mo">6 months (YF)</option>
            <option value="1y">1 year (YF)</option>
            <option value="compact">Latest 100 bars (AV)</option>
            <option value="full">Full history (AV)</option>
          </select>
        </div>
        <div>
          <label>Alpha Vantage API Key (optional)</label>
          <input id="d-avkey" placeholder="Store your key here" />
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button id="btn-fetch" class="btn btn-primary" onclick="fetchAndAnalyze()">Fetch & Analyze</button>
        <button class="btn btn-outline" onclick="testProviders()">Test Providers</button>
        <div id="fetch-state" class="flex small" style="gap:6px"></div>
        <div class="right flex">
          <label class="switch"><input id="d-autoref" type="checkbox" /><span class="slider"></span></label>
          <span class="small">Auto refresh</span>
          <input id="d-autoref-min" type="number" class="small" style="width:90px" value="5" />
          <span class="small">min</span>
        </div>
      </div>
      <div class="notice small" style="margin-top:8px">
        <b>Tip:</b> For NSE tickers on Yahoo, append <b>.NS</b> (e.g., <code class="inline">RELIANCE.NS</code>); for BSE tickers, use <b>.BO</b>. Typing a bare symbol auto‑adds the suffix based on the Exchange field.
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Watchlist</h3>
      <div class="row row-2">
        <div><input id="w-add" placeholder="Symbol (without suffix)" /></div>
        <div class="flex">
          <button class="btn btn-outline" onclick="addWatch()">Add</button>
          <button class="btn btn-outline" onclick="clearWatch()">Clear</button>
          <div class="right small muted">Respects provider/rate limits. Use batch sparingly.</div>
        </div>
      </div>
      <div id="watchlist"></div>
      <div class="flex" style="margin-top:8px">
        <button class="btn btn-primary" onclick="batchFetch()">Fetch Selected</button>
        <div class="right small muted">Batch waits between requests to avoid rate limits.</div>
      </div>
    </div>
  </section>

  <!-- STRATEGY -->
  <section id="strategy">
    <div class="card">
      <h2 style="margin-top:0">Core Strategy: Trend Breakout + Retest (Equity)</h2>
      <ol>
        <li><b>Market Filter</b>: Trade in the direction of the <b>Daily</b> trend (HH/HL uptrend, LH/LL downtrend).</li>
        <li><b>Setup</b>: On the <b>1H or 15M</b> chart, price consolidates below a clear resistance or above support.</li>
        <li><b>Trigger</b>: A strong <b>breakout candle</b> closes beyond the level. Prefer volume &gt; 1.5× 20‑bar average.</li>
        <li><b>Entry</b>: On a <b>retest</b> of the breakout level, wait for a confirmation candle and enter.</li>
        <li><b>Stop‑loss</b>: Beyond invalidation (last swing low/high) or 1× ATR(14), whichever is wider.</li>
        <li><b>Targets</b>: First target at 2R; trail remainder behind swing lows/highs or ATR multiple.</li>
        <li><b>Risk</b>: Risk ≤ <b>1% of capital</b> per trade.</li>
      </ol>
    </div>
  </section>

  <!-- JOURNAL -->
  <section id="journal">
    <div class="card">
      <h2 style="margin-top:0">New Equity Trade</h2>
      <div class="row row-2">
        <div>
          <label>Symbol</label>
          <input id="t-symbol" placeholder="e.g., RELIANCE, TCS" />
        </div>
        <div>
          <label>Direction</label>
          <select id="t-dir"><option>LONG</option><option>SHORT</option></select>
        </div>
        <div>
          <label>Entry Price</label>
          <input id="t-entry" type="number" step="0.01" placeholder="2510.50" />
        </div>
        <div>
          <label>Stop-loss</label>
          <input id="t-stop" type="number" step="0.01" placeholder="2480.00" />
        </div>
        <div>
          <label>Target</label>
          <input id="t-target" type="number" step="0.01" placeholder="Optional" />
        </div>
        <div>
          <label>Quantity (auto if blank)</label>
          <input id="t-qty" type="number" step="1" placeholder="Leave empty to auto-calc" />
        </div>
        <div class="row" style="grid-column:1 / -1">
          <label>Notes</label>
          <textarea id="t-notes" placeholder="Why this trade? Level, pattern, checklist…"></textarea>
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn btn-primary" onclick="createTrade()">Add Trade</button>
        <button class="btn btn-outline" onclick="go('position')">Position Size</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Open Positions</h3>
      <div id="open-trades"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Closed Positions</h3>
      <div id="closed-trades"></div>
    </div>
  </section>

  <!-- ANALYZER -->
  <section id="scanner">
    <div class="card">
      <h2 style="margin-top:0">Analyzer</h2>
      <p class="small">When you fetch data from <b>Data</b>, it flows here. You can still paste CSV if you like.</p>
      <textarea id="csv-input" placeholder="Date,Open,High,Low,Close,Volume
2025-07-01,2540,2562,2531,2555,12345678
2025-07-02,2556,2575,2548,2570,11876543"></textarea>
      <div class="flex" style="margin-top:10px">
        <button class="btn btn-outline" onclick="analyzeCSV()">Analyze Pasted CSV</button>
        <button class="btn btn-outline" onclick="clearCSV()">Clear</button>
        <div class="right"><small class="muted">20‑bar breakout, ATR(14), volume expansion.</small></div>
      </div>
    </div>

    <div id="scan-results" class="card" style="display:none">
      <div class="flex">
        <h3 style="margin:0">Signals</h3>
        <div id="meta-sym" class="right small muted"></div>
      </div>
      <div id="signals"></div>
      <hr />
      <canvas id="chart"></canvas>
    </div>
  </section>

  <!-- POSITION / SETTINGS -->
  <section id="position">
    <div class="card">
      <h2 style="margin-top:0">Account & Risk</h2>
      <div class="row row-2">
        <div><label>Trading Capital (₹)</label><input id="s-capital" type="number" step="0.01" /></div>
        <div><label>Risk per Trade (%)</label><input id="s-riskpct" type="number" step="0.1" /></div>
        <div><label>Brokerage + Taxes (%)</label><input id="s-fees" type="number" step="0.01" /></div>
        <div><label>Slippage (%)</label><input id="s-slip" type="number" step="0.01" /></div>
        <div><label>Currency Symbol</label><input id="s-curr" placeholder="₹" /></div>
        <div><label>Max Concurrent Positions</label><input id="s-maxopen" type="number" step="1" /></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn btn-primary" onclick="saveSettings()">Save</button>
        <button class="btn btn-outline" onclick="resetSettings()">Defaults</button>
      </div>
    </div>
  </section>

  <!-- BACKUP -->
  <section id="backup">
    <div class="card">
      <h2 style="margin-top:0">Backup & Data</h2>
      <div class="row row-2">
        <div class="notice">
          <b>Your journal data lives on this device</b> (localStorage). Export regularly if you clear cache or switch phones.
        </div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button class="btn btn-primary" onclick="exportData()">Export JSON</button>
        <label class="btn btn-outline" for="import-file">Import JSON</label>
        <input id="import-file" type="file" accept="application/json" style="display:none" />
        <button class="btn btn-danger right" onclick="resetAll()">Wipe All Data</button>
      </div>
    </div>
  </section>

  <!-- HELP -->
  <section id="help">
    <div class="card">
      <h2 style="margin-top:0">How to Use</h2>
      <div class="help-step"><b>1) Data</b> — Pick provider (AUTO recommended), set exchange + symbol (e.g., <code class="inline">RELIANCE</code>), choose interval, press <b>Fetch & Analyze</b>.</div>
      <div class="help-step"><b>2) Analyze</b> — Trend, 20‑bar breakouts, ATR(14), volume expansion, candlesticks.</div>
      <div class="help-step"><b>3) Position Size</b> — Compute quantity with risk ≤ 1%.</div>
      <div class="help-step"><b>4) Journal</b> — Record entries/exits; review KPIs weekly.</div>
      <div class="notice"><span class="warning">Disclaimer:</span> Trading involves substantial risk. Data use is subject to each provider’s Terms. This tool is educational only.</div>
    </div>
    <footer>v1.3 • Equity + Auto‑Data • Built for GitHub Pages • © You</footer>
  </section>
</main>

<script>
(function(){
  const STORAGE_KEY = 'pa_trader_equity_auto_v13';

  // ---------- Default state ----------
  const DEFAULTS = {
    capital: 100000,
    riskPct: 1.0,
    feesPct: 0.03,
    slipPct: 0.02,
    currency: '₹',
    maxOpen: 3,
    trades: [],
    checklist: [
      {id:'d-trend', text:'Daily trend aligns with trade direction', checked:false},
      {id:'level-clear', text:'Clean level with multiple touches (S/R)', checked:false},
      {id:'consolidation', text:'Tight consolidation before breakout', checked:false},
      {id:'breakout-close', text:'Breakout candle closes beyond level', checked:false},
      {id:'retest', text:'Price retests level; confirmation candle', checked:false},
      {id:'vol', text:'Volume ≥ 1.5× 20-bar average', checked:false},
      {id:'sl', text:'Stop set beyond invalidation / ≥ 1×ATR', checked:false},
      {id:'rr', text:'Reward ≥ 2R to first target', checked:false},
      {id:'size', text:'Position size ≤ 1% risk', checked:false},
      {id:'news', text:'No major event in next 24h', checked:false}
    ],
    data: {
      provider: 'AUTO',   // AUTO | YF | AV
      exch: 'NS',         // NS | BO
      interval: '1d',     // 1d | 60m | 15m
      range: '3mo',       // YF: 3mo/6mo/1y ; AV: compact/full
      symbol: 'RELIANCE',
      avKey: '',
      autoref: false,
      autorefMin: 5,
      watch: [],
      cache: {}
    }
  };

  // ---------- State, storage, helpers ----------
  let state = load();
  let activeTabId = 'dashboard'; // preserve current tab across renders
  function deepMerge(a,b){ const out={...a}; for(const k in b){ if(!(k in out)) out[k]=b[k]; else if(typeof out[k]==='object' && out[k] && !Array.isArray(out[k])) out[k]=deepMerge(out[k], b[k]); } return out; }
  function load(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      if(!raw) return JSON.parse(JSON.stringify(DEFAULTS));
      return deepMerge(JSON.parse(raw), DEFAULTS);
    }catch(e){ return JSON.parse(JSON.stringify(DEFAULTS)); }
  }
  function save(opts={rerender:false}){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    if(opts.rerender) renderAll();
  }
  function fmt(n){ if(n==null || isNaN(n)) return '—'; return (state.currency||'₹')+' '+Number(n).toLocaleString(undefined,{maximumFractionDigits:2}); }
  function f2(n){ if(n==null || isNaN(n)) return '—'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:2}); }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

  // ---------- Tabs ----------
  const tabs = [
    {id:'dashboard', label:'Dashboard'},
    {id:'data', label:'Data'},
    {id:'strategy', label:'Strategy'},
    {id:'journal', label:'Journal'},
    {id:'scanner', label:'Analyzer'},
    {id:'position', label:'Position Size'},
    {id:'backup', label:'Backup'},
    {id:'help', label:'Help'}
  ];
  const tabEl = document.getElementById('tabs');
  tabs.forEach(t=>{ const b=document.createElement('button'); b.textContent=t.label; b.onclick=()=>go(t.id); b.id='tab-'+t.id; tabEl.appendChild(b); });
  window.go = function(id){
    activeTabId = id;
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    if(id==='scanner'){ setTimeout(()=>resizeChart(),0); }
  };

  // ---------- Checklist ----------
  function renderChecklist(){
    const tcont = document.getElementById('today-checklist');
    tcont.innerHTML='';
    state.checklist.forEach(item=>{
      const wrap=document.createElement('div'); wrap.className='card'; wrap.style.margin='0';
      wrap.innerHTML=`<div class="flex"><div>${item.text}</div>
        <div class="right">
        <label class="switch">
          <input type="checkbox" id="tod-${item.id}" ${item.checked?'checked':''}>
          <span class="slider"></span>
        </label></div></div>`;
      tcont.appendChild(wrap);
    });
  }
  window.saveChecklist = function(){
    state.checklist = state.checklist.map(item=>{
      const el = document.getElementById('tod-'+item.id);
      return {...item, checked: !!(el && el.checked)};
    });
    save();
  }
  window.resetChecklist = function(){ state.checklist = JSON.parse(JSON.stringify(DEFAULTS.checklist)); save({rerender:true}); }

  // ---------- Settings & KPIs ----------
  const sEls = {
    capital: document.getElementById('s-capital'),
    riskpct: document.getElementById('s-riskpct'),
    fees: document.getElementById('s-fees'),
    slip: document.getElementById('s-slip'),
    curr: document.getElementById('s-curr'),
    maxopen: document.getElementById('s-maxopen')
  };
  function renderSettings(){
    sEls.capital.value = state.capital;
    sEls.riskpct.value = state.riskPct;
    sEls.fees.value    = state.feesPct;
    sEls.slip.value    = state.slipPct;
    sEls.curr.value    = state.currency || '₹';
    sEls.maxopen.value = state.maxOpen;
  }
  window.saveSettings = function(){
    state.capital = +sEls.capital.value||0;
    state.riskPct = +sEls.riskpct.value||0;
    state.feesPct = +sEls.fees.value||0;
    state.slipPct = +sEls.slip.value||0;
    state.currency= sEls.curr.value||'₹';
    state.maxOpen = parseInt(sEls.maxopen.value||'3',10);
    save(); alert('Saved.');
  }
  window.resetSettings = function(){ Object.assign(state, {...state, ...DEFAULTS, trades: state.trades}); save({rerender:true}); }

  function renderKPIs(){
    const closed = state.trades.filter(t=>t.status==='CLOSED');
    const open   = state.trades.filter(t=>t.status==='OPEN');
    document.getElementById('kpi-capital').textContent = fmt(state.capital);
    document.getElementById('kpi-risk').textContent    = f2(state.riskPct)+' %';
    document.getElementById('kpi-open').textContent    = open.length;
    document.getElementById('kpi-curr').textContent    = state.currency||'₹';

    let wins=0, losses=0, pnl=0, rWins=[], rLosses=[];
    const equity=[0];
    closed.forEach(t=>{
      pnl += (t.pnl||0);
      if((t.pnl||0)>=0){ wins++; rWins.push(t.rMultiple||0);} else { losses++; rLosses.push(t.rMultiple||0); }
      equity.push(pnl);
    });
    const total=wins+losses; const winrate = total? (wins/total*100):0;
    document.getElementById('kpi-winrate').textContent = f2(winrate)+' %';
    document.getElementById('kpi-pnl').textContent     = fmt(pnl);
    function maxDrawdown(arr){ let max=arr[0], dd=0; for(let i=1;i<arr.length;i++){ if(arr[i]>max) max=arr[i]; dd = Math.min(dd, arr[i]-max);} return Math.abs(dd); }
    document.getElementById('kpi-dd').textContent = fmt(maxDrawdown(equity));
    const avg=a=>a.length?a.reduce((x,y)=>x+y,0)/a.length:0;
    const expR = Math.abs(avg(rWins))*(winrate/100) - Math.abs(avg(rLosses))*(1-winrate/100);
    document.getElementById('kpi-exp').textContent = f2(expR);
  }

  // ---------- Journal ----------
  function renderTrades(){
    const open = state.trades.filter(t=>t.status==='OPEN').sort((a,b)=>b.openTs-a.openTs);
    const closed = state.trades.filter(t=>t.status==='CLOSED').sort((a,b)=>b.closeTs-a.closeTs);

    const openWrap = document.getElementById('open-trades');
    const closedWrap = document.getElementById('closed-trades');

    // Open
    const ot = document.createElement('table');
    ot.innerHTML = `<thead><tr><th>Symbol</th><th>Dir</th><th>Entry</th><th>Stop</th><th>Qty</th><th>R (init)</th><th>Opened</th><th></th></tr></thead>`;
    const ob = document.createElement('tbody');
    open.forEach(t=>{
      const r=document.createElement('tr');
      const initRisk = Math.abs(t.entry - t.stop) * t.qty;
      r.innerHTML = `<td><b>${t.symbol}</b></td><td>${t.direction}</td><td>${f2(t.entry)}</td><td>${f2(t.stop)}</td><td>${t.qty}</td><td>${fmt(initRisk)}</td><td>${new Date(t.openTs).toLocaleString()}</td><td><button class="btn btn-outline" onclick="closeTradePrompt('${t.id}')">Close</button></td>`;
      ob.appendChild(r);
    });
    ot.appendChild(ob);
    openWrap.innerHTML=''; openWrap.appendChild(ot);
    if(open.length===0){ openWrap.innerHTML='<small class="muted">No open positions.</small>'; }

    // Closed
    const ct = document.createElement('table');
    ct.innerHTML = `<thead><tr><th>Symbol</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Qty</th><th>P&amp;L</th><th>R</th><th>Closed</th></tr></thead>`;
    const cb = document.createElement('tbody');
    closed.forEach(t=>{
      const r=document.createElement('tr');
      const rVal = (t.rMultiple!==undefined) ? t.rMultiple.toFixed(2) : '—';
      const pnlCls = (t.pnl||0)>=0 ? 'pos' : 'neg';
      r.innerHTML = `<td><b>${t.symbol}</b></td><td>${t.direction}</td><td>${f2(t.entry)}</td><td>${f2(t.exit)}</td><td>${t.qty}</td><td class="${pnlCls}">${fmt(t.pnl)}</td><td>${rVal}</td><td>${new Date(t.closeTs).toLocaleString()}</td>`;
      cb.appendChild(r);
    });
    ct.appendChild(cb);
    closedWrap.innerHTML=''; closedWrap.appendChild(ct);
    if(closed.length===0){ closedWrap.innerHTML='<small class="muted">No closed positions.</small>'; }
  }
  window.createTrade = function(){
    const symbol = document.getElementById('t-symbol').value.trim().toUpperCase();
    const direction = document.getElementById('t-dir').value;
    const entry = +document.getElementById('t-entry').value;
    const stop  = +document.getElementById('t-stop').value;
    const target= +document.getElementById('t-target').value || null;
    let qty = parseInt(document.getElementById('t-qty').value||'0',10);
    const notes = document.getElementById('t-notes').value.trim();
    if(!symbol || !isFinite(entry) || !isFinite(stop)){ alert('Symbol, entry and stop are required.'); return; }
    if(qty<=0){
      const pos = computePosition(entry, stop, target);
      if(!pos.ok){ alert('Unable to auto-calc quantity. Provide qty.'); return; }
      qty = pos.qty;
    }
    const trade = { id: uid(), symbol, direction, entry, stop, target, qty, notes, openTs: Date.now(), status:'OPEN' };
    state.trades.push(trade);
    save({rerender:true});
    ['t-symbol','t-entry','t-stop','t-target','t-qty','t-notes'].forEach(id=>document.getElementById(id).value='');
    alert('Trade added.');
  }
  window.closeTradePrompt = function(id){
    const t = state.trades.find(x=>x.id===id);
    if(!t) return;
    const price = prompt(`Exit price for ${t.symbol} (${t.direction})?`);
    if(price===null) return;
    const exit = +price;
    if(!isFinite(exit)){ alert('Invalid price'); return; }
    const riskPer = Math.abs(t.entry - t.stop);
    let pnl = (t.direction==='LONG' ? (exit - t.entry) : (t.entry - exit)) * t.qty;
    const fees = (t.entry * t.qty + exit * t.qty) * (state.feesPct/100);
    const slip = (t.entry + exit) * (state.slipPct/100) * t.qty;
    pnl -= (fees + slip);
    t.exit = exit; t.pnl = pnl;
    t.rMultiple = riskPer>0 ? ( (t.direction==='LONG' ? (exit - t.entry) : (t.entry - exit)) / riskPer ) : 0;
    t.status = 'CLOSED'; t.closeTs = Date.now();
    save({rerender:true});
  }
  function computePosition(entry, stop, target){
    if(!isFinite(entry) || !isFinite(stop) || entry===stop) return {ok:false};
    const riskAmt = state.capital * (state.riskPct/100);
    const riskPerShare = Math.abs(entry - stop);
    let qty = Math.floor(riskAmt / riskPerShare);
    if(qty<1) qty=1;
    const exposure = qty * entry;
    const fees = exposure * (state.feesPct/100);
    const slip = entry * (state.slipPct/100) * qty;
    const beMove = (fees + slip) / qty;
    let rrText = '—';
    if(isFinite(target)){ const rewardPer = Math.abs(target - entry); const rr = rewardPer / riskPerShare; rrText = rr.toFixed(2)+' R'; }
    return {ok:true, riskAmt, riskPerShare, qty, exposure, fees, slip, beMove, rrText};
  }

  // ---------- Analyzer ----------
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/).filter(x=>x.trim().length>0);
    if(lines.length<2) return [];
    const head = lines[0].split(',').map(x=>x.trim().toLowerCase());
    const idx = {
      date: head.findIndex(h=>/date/.test(h)),
      open: head.findIndex(h=>/open/.test(h)),
      high: head.findIndex(h=>/high/.test(h)),
      low:  head.findIndex(h=>/low/.test(h)),
      close:head.findIndex(h=>/close/.test(h)),
      volume:head.findIndex(h=>/vol/.test(h))
    };
    const data=[];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(',').map(x=>x.trim());
      const item = {
        date: idx.date>=0 ? cols[idx.date] : (i+''),
        open:+cols[idx.open], high:+cols[idx.high], low:+cols[idx.low], close:+cols[idx.close],
        volume: idx.volume>=0 ? +cols[idx.volume] : 0
      };
      if([item.open,item.high,item.low,item.close].every(v=>isFinite(v))) data.push(item);
    }
    const asc = new Date(data[0].date).getTime() <= new Date(data[data.length-1].date).getTime();
    return asc ? data : data.reverse();
  }
  function sma(arr, period){
    const out=[]; let sum=0;
    for(let i=0;i<arr.length;i++){ sum+=arr[i]; if(i>=period) sum-=arr[i-period]; out.push(i>=period-1? sum/period : NaN); }
    return out;
  }
  function atr14(data){
    const trs = data.map((d,i)=>{ const prev=i>0?data[i-1]:d; const tr = Math.max(d.high-d.low, Math.abs(d.high-prev.close), Math.abs(d.low-prev.close)); return tr; });
    return sma(trs,14);
  }
  function rollingMax(arr, p, acc){ const out=[]; let dq=[]; for(let i=0;i<arr.length;i++){ const v=acc(arr[i]); while(dq.length && dq[dq.length-1].v<=v) dq.pop(); dq.push({i,v}); while(dq.length && dq[0].i<=i-p) dq.shift(); out.push(dq[0].v);} return out; }
  function rollingMin(arr, p, acc){ const out=[]; let dq=[]; for(let i=0;i<arr.length;i++){ const v=acc(arr[i]); while(dq.length && dq[dq.length-1].v>=v) dq.pop(); dq.push({i,v}); while(dq.length && dq[0].i<=i-p) dq.shift(); out.push(dq[0].v);} return out; }
  function detectTrend(data){
    const closes = data.map(d=>d.close);
    const ma20 = sma(closes,20);
    const n = data.length-1;
    const slope = ma20[n]-ma20[n-5];
    if(!isFinite(ma20[n])||!isFinite(slope)) return 'Unknown';
    if(closes[n]>ma20[n] && slope>0) return 'Uptrend';
    if(closes[n]<ma20[n] && slope<0) return 'Downtrend';
    return 'Range/Neutral';
  }
  function analyze(data, meta){
    if(data.length<25) return {ok:false, msg:'Need at least 25 rows of data.'};
    const n = data.length-1;
    const vols = data.map(d=>d.volume||0);
    const atr = atr14(data);
    const maVol = sma(vols,20);
    const prevHigh20 = rollingMax(data,20,d=>d.high)[n-1];
    const prevLow20  = rollingMin(data,20,d=>d.low)[n-1];
    const breakoutUp = data[n].close > prevHigh20;
    const breakoutDn = data[n].close < prevLow20;
    const volExp = isFinite(maVol[n]) ? vols[n] > 1.5*maVol[n] : false;
    const trend = detectTrend(data);

    const bullets=[];
    bullets.push(`<div class="summary">Trend: ${trend}</div>`);
    if(breakoutUp) bullets.push(`✅ <b>Upside breakout</b> above prior 20‑bar high (${f2(prevHigh20)}).`);
    if(breakoutDn) bullets.push(`✅ <b>Downside breakout</b> below prior 20‑bar low (${f2(prevLow20)}).`);
    if(!breakoutUp && !breakoutDn) bullets.push('ℹ️ No 20‑bar breakout on the latest bar.');
    bullets.push(`ATR(14): <b>${f2(atr[n])}</b>`);
    bullets.push(`Volume Expansion: <b>${volExp ? 'Yes (≥1.5× avg)' : 'No'}</b>`);

    const out = document.getElementById('signals');
    out.innerHTML = '<ul><li>'+bullets.join('</li><li>')+'</li></ul>';
    const metaEl = document.getElementById('meta-sym'); metaEl.textContent = meta||'';

    document.getElementById('scan-results').style.display='block';
    resizeChart(); drawChart(data);
    return {ok:true};
  }
  function analyzeCSV(){ const data = parseCSV(document.getElementById('csv-input').value); const res = analyze(data); if(!res.ok){ alert(res.msg); } }
  window.analyzeCSV = analyzeCSV;
  window.clearCSV = function(){ document.getElementById('csv-input').value=''; document.getElementById('scan-results').style.display='none'; }

  // ---------- Chart ----------
  let chartCanvas = document.getElementById('chart');
  function resizeChart(){ if(!chartCanvas) chartCanvas=document.getElementById('chart'); if(!chartCanvas) return;
    const dpr=window.devicePixelRatio||1; const w=chartCanvas.clientWidth; const h=chartCanvas.clientHeight;
    chartCanvas.width=Math.floor(w*dpr); chartCanvas.height=Math.floor(h*dpr); const ctx=chartCanvas.getContext('2d'); ctx.scale(dpr,dpr);
  }
  function drawChart(data){
    if(!chartCanvas) return;
    const ctx=chartCanvas.getContext('2d'); const W=chartCanvas.clientWidth; const H=chartCanvas.clientHeight;
    ctx.clearRect(0,0,W,H);
    const view=data.slice(-100);
    const highs=view.map(d=>d.high), lows=view.map(d=>d.low);
    const maxH=Math.max(...highs), minL=Math.min(...lows);
    const pad=8; const y=v=>pad+(H-2*pad)*(1-(v-minL)/(maxH-minL||1)); const xStep=(W-2*pad)/view.length;
    ctx.strokeStyle='#1f2937'; ctx.lineWidth=1;
    for(let i=0;i<5;i++){ const yy=pad+(H-2*pad)*i/4; ctx.beginPath(); ctx.moveTo(pad,yy); ctx.lineTo(W-pad,yy); ctx.stroke(); }
    for(let i=0;i<view.length;i++){
      const d=view[i]; const x=pad+i*xStep+xStep*0.5; const up=d.close>=d.open;
      ctx.strokeStyle=up?'#10b981':'#ef4444'; ctx.fillStyle=ctx.strokeStyle;
      ctx.beginPath(); ctx.moveTo(x,y(d.high)); ctx.lineTo(x,y(d.low)); ctx.stroke();
      const bw=Math.max(2,xStep*0.6); const top=y(Math.max(d.open,d.close)); const bot=y(Math.min(d.open,d.close)); const h=Math.max(1,bot-top);
      ctx.fillRect(x-bw/2, top, bw, h);
    }
  }
  window.addEventListener('resize', resizeChart);

  // ---------- Data providers ----------
  const dEls = {
    provider: document.getElementById('d-provider'),
    exch: document.getElementById('d-exch'),
    symbol: document.getElementById('d-symbol'),
    interval: document.getElementById('d-interval'),
    range: document.getElementById('d-range'),
    avkey: document.getElementById('d-avkey'),
    autoref: document.getElementById('d-autoref'),
    autorefMin: document.getElementById('d-autoref-min'),
    watchAdd: document.getElementById('w-add'),
    watchBox: document.getElementById('watchlist'),
    fetchState: document.getElementById('fetch-state')
  };

  function renderDataSettings(){
    dEls.provider.value = state.data.provider;
    dEls.exch.value     = state.data.exch;
    dEls.symbol.value   = state.data.symbol;
    dEls.interval.value = state.data.interval;
    dEls.range.value    = state.data.range;
    dEls.avkey.value    = state.data.avKey;
    dEls.autoref.checked= !!state.data.autoref;
    dEls.autorefMin.value = state.data.autorefMin;
    renderWatch();
  }
  function saveDataSettings(){
    state.data.provider = dEls.provider.value;
    state.data.exch     = dEls.exch.value;
    state.data.symbol   = dEls.symbol.value.trim().toUpperCase();
    state.data.interval = dEls.interval.value;
    state.data.range    = dEls.range.value;
    state.data.avKey    = dEls.avkey.value.trim();
    state.data.autoref  = !!dEls.autoref.checked;
    state.data.autorefMin = parseInt(dEls.autorefMin.value||'5',10);
    // Persist WITHOUT re-render (prevents tab jump/focus loss)
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    // update only watchlist table if needed
    if(typeof renderWatch==='function') renderWatch();
  }
  // Persist settings on "change" only (typing won't re-render)
  ['d-provider','d-exch','d-symbol','d-interval','d-range','d-avkey','d-autoref','d-autoref-min']
    .forEach(id => { const el=document.getElementById(id); if(!el) return; el.addEventListener('change', saveDataSettings); });
  // QoL: Enter in Symbol triggers fetch, no re-render
  dEls.symbol.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ fetchAndAnalyze(); } });

  const YF = {
    normalizeSymbol(sym, exch){ if(/\.[A-Za-z]+$/.test(sym)) return sym; return sym + (exch==='BO'?'.BO':'.NS'); },
    async fetch(sym, iv, range){
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(sym)}?interval=${encodeURIComponent(iv)}&range=${encodeURIComponent(range)}&events=div%2Csplit`;
      const res = await fetch(url, {mode:'cors'});
      if(!res.ok) throw new Error('Yahoo HTTP '+res.status);
      const j = await res.json();
      const r = j?.chart?.result?.[0];
      if(!r || !r.timestamp || !r.indicators?.quote?.[0]) throw new Error('Yahoo response unexpected');
      const q = r.indicators.quote[0];
      const out=[];
      for(let i=0;i<r.timestamp.length;i++){
        const o=q.open[i], h=q.high[i], l=q.low[i], c=q.close[i], v=q.volume[i];
        if([o,h,l,c].some(x=>!isFinite(x))) continue;
        out.push({date:new Date(r.timestamp[i]*1000).toISOString(), open:o, high:h, low:l, close:c, volume:v||0});
      }
      return out;
    }
  };
  const AV = {
    normalizeSymbol(sym, exch){ if(/\.[A-Za-z]+$/.test(sym)) return sym; return sym + (exch==='BO'?'.BO':'.NS'); },
    mapIv(iv){ return iv==='1d'?'':(iv==='60m'?'60min':iv==='15m'?'15min':iv); },
    async fetchDaily(sym, size, key){
      const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${encodeURIComponent(sym)}&outputsize=${encodeURIComponent(size)}&apikey=${encodeURIComponent(key)}`;
      const res = await fetch(url, {mode:'cors'}); const j=await res.json();
      if(j['Note']||j['Information']) throw new Error(j['Note']||j['Information']);
      if(j['Error Message']) throw new Error(j['Error Message']);
      const series = j['Time Series (Daily)']; if(!series) throw new Error('AV daily: missing series');
      const out = Object.keys(series).map(d=>{
        const row=series[d]; return {date:new Date(d).toISOString(), open:+row['1. open'], high:+row['2. high'], low:+row['3. low'], close:+row['4. close'], volume:+row['6. volume']||+row['5. volume']||0};
      }).filter(x=>[x.open,x.high,x.low,x.close].every(v=>isFinite(v))).sort((a,b)=>new Date(a.date)-new Date(b.date));
      return out;
    },
    async fetchIntraday(sym, iv, size, key){
      const avIv = (iv==='60m'?'60min':iv==='15m'?'15min':iv);
      const url = `https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=${encodeURIComponent(sym)}&interval=${encodeURIComponent(avIv)}&outputsize=${encodeURIComponent(size)}&adjusted=true&apikey=${encodeURIComponent(key)}`;
      const res = await fetch(url, {mode:'cors'}); const j=await res.json();
      if(j['Note']||j['Information']) throw new Error(j['Note']||j['Information']);
      if(j['Error Message']) throw new Error(j['Error Message']);
      const keyName = `Time Series (${avIv})`; const series = j[keyName];
      if(!series) throw new Error('AV intraday: missing series');
      const out = Object.keys(series).map(d=>{
        const row=series[d]; return {date:new Date(d.replace(' ','T')+'Z').toISOString(), open:+row['1. open'], high:+row['2. high'], low:+row['3. low'], close:+row['4. close'], volume:+row['5. volume']||0};
      }).filter(x=>[x.open,x.high,x.low,x.close].every(v=>isFinite(v))).sort((a,b)=>new Date(a.date)-new Date(b.date));
      return out;
    }
  };

  function ttlFor(iv){ return iv==='1d' ? 6*60*60*1000 : 10*60*1000; } // cache TTL: 6h daily; 10m intraday
  function cacheKey(sym, iv, provider, range){ return [sym,iv,provider,range].join('|'); }
  function getCache(key){ const c=state.data.cache[key]; if(!c) return null; if(Date.now()-c.ts > (c.ttl||0)) return null; return c.data; }
  function setCache(key,data,ttl){ state.data.cache[key]={ts:Date.now(),data,ttl}; save(); }

  function normalizeSymbolInput(raw, exch){
    raw = raw.trim().toUpperCase(); if(!raw) return raw;
    if(/\.[A-Za-z]+$/.test(raw)) return raw; // already has .NS/.BO
    return raw + (exch==='BO'?'.BO':'.NS');
  }

  function showFetchState(txt, spinning=false){
    dEls.fetchState.innerHTML=''; if(spinning){ const s=document.createElement('div'); s.className='spinner'; dEls.fetchState.appendChild(s); }
    const t=document.createElement('div'); t.textContent = txt; dEls.fetchState.appendChild(t);
  }

  async function fetchAuto(sym, iv, range, key){
    try{
      showFetchState('Yahoo Finance…', true);
      const data = await YF.fetch(sym, iv, range);
      return {provider:'YF', data};
    }catch(e){
      if(!key) throw new Error('Yahoo failed and no Alpha Vantage key configured.');
      showFetchState('Alpha Vantage…', true);
      if(iv==='1d'){ const data = await AV.fetchDaily(sym, (range==='full'?'full':'compact'), key); return {provider:'AV', data}; }
      const data = await AV.fetchIntraday(sym, iv, (range==='full'?'full':'compact'), key); return {provider:'AV', data};
    }
  }
  async function fetchFromProvider(p, sym, iv, range, key){
    if(p==='AUTO') return fetchAuto(sym, iv, range, key);
    if(p==='YF'){ const data = await YF.fetch(sym, iv, range); return {provider:'YF', data}; }
    if(p==='AV'){
      if(!key) throw new Error('Alpha Vantage key required.');
      if(iv==='1d'){ const data=await AV.fetchDaily(sym, (range==='full'?'full':'compact'), key); return {provider:'AV', data}; }
      const data=await AV.fetchIntraday(sym, iv, (range==='full'?'full':'compact'), key); return {provider:'AV', data};
    }
    throw new Error('Unknown provider');
  }

  let autorefTimer=null;
  window.fetchAndAnalyze = async function(){
    try{
      saveDataSettings();
      const exch=state.data.exch; const rawSym=state.data.symbol; const sym=normalizeSymbolInput(rawSym,exch);
      const iv=state.data.interval; const range=state.data.range; const provider=state.data.provider; const key=state.data.avKey;
      const ckey=cacheKey(sym,iv,provider,range); const cached=getCache(ckey);
      if(cached){ showFetchState('Using cached data'); analyze(cached, `${sym} • ${iv} • ${provider}`); go('scanner'); return; }
      showFetchState('Fetching…', true);
      const {provider:used,data}=await fetchFromProvider(provider,sym,iv,range,key);
      setCache(ckey,data,ttlFor(iv));
      showFetchState(`Fetched via ${used}`);
      analyze(data, `${sym} • ${iv} • ${used}`);
      // Fill CSV for transparency
      const csv = 'Date,Open,High,Low,Close,Volume\n' + data.map(d=>[d.date,d.open,d.high,d.low,d.close,d.volume].join(',')).join('\n');
      document.getElementById('csv-input').value = csv;
      go('scanner');
    }catch(err){
      console.error(err); showFetchState('Error');
      alert('Data fetch failed: '+err.message+'\n• If Yahoo is blocked by CORS, switch to Alpha Vantage and add your API key.\n• Ensure .NS/.BO suffix is correct.');
    }finally{
      // manage auto refresh
      clearInterval(autorefTimer);
      if(state.data.autoref){ const ms=Math.max(1,state.data.autorefMin)*60*1000; autorefTimer=setInterval(()=>fetchAndAnalyze(), ms); }
    }
  };

  window.testProviders = async function(){
    try{
      showFetchState('Testing providers…', true);
      const sym = normalizeSymbolInput('RELIANCE', dEls.exch.value);
      // Test YF
      let yfOK=false, avOK=false;
      try{ await YF.fetch(sym,'1d','3mo'); yfOK=true; }catch(e){ yfOK=false; }
      // Test AV (only if key present)
      const key=(dEls.avkey.value||'').trim();
      if(key){ try{ await AV.fetchDaily(sym,'compact',key); avOK=true; }catch(e){ avOK=false; } }
      const msg = `Yahoo: ${yfOK?'OK ✅':'Blocked/Fail ❌'}  •  Alpha Vantage: ${key? (avOK?'OK ✅':'Fail ❌') : 'No key'}`;
      showFetchState(msg);
    }catch(e){
      showFetchState('Test failed'); alert('Test failed: '+e.message);
    }
  };

  // ---------- Watchlist ----------
  function renderWatch(){
    const box=dEls.watchBox; box.innerHTML='';
    if(!state.data.watch || state.data.watch.length===0){ box.innerHTML='<small class="muted">No symbols. Add some to watch.</small>'; return; }
    const t=document.createElement('table');
    t.innerHTML='<thead><tr><th></th><th>Symbol</th><th>Exchange</th><th></th></tr></thead>';
    const b=document.createElement('tbody');
    state.data.watch.forEach((w,i)=>{
      const r=document.createElement('tr');
      r.innerHTML = `<td><input type="checkbox" id="wsel-${i}"></td><td>${w.symbol}</td><td>${w.exch}</td>
      <td><button class="btn btn-outline" onclick="fetchOneWatch(${i})">Fetch</button> <button class="btn btn-outline" onclick="delWatch(${i})">Remove</button></td>`;
      b.appendChild(r);
    });
    t.appendChild(b); box.appendChild(t);
  }
  window.addWatch = function(){
    const s=dEls.watchAdd.value.trim().toUpperCase(); if(!s) return;
    state.data.watch.push({symbol:s, exch: state.data.exch}); dEls.watchAdd.value=''; save(); renderWatch();
  }
  window.delWatch = function(i){ state.data.watch.splice(i,1); save(); renderWatch(); }
  window.clearWatch = function(){ if(confirm('Clear entire watchlist?')){ state.data.watch=[]; save(); renderWatch(); } }
  window.fetchOneWatch = async function(i){ state.data.symbol = state.data.watch[i].symbol; state.data.exch = state.data.watch[i].exch; renderDataSettings(); await fetchAndAnalyze(); }
  window.batchFetch = async function(){
    saveDataSettings();
    const selectedIdx=[]; state.data.watch.forEach((w,i)=>{ const el=document.getElementById('wsel-'+i); if(el&&el.checked) selectedIdx.push(i); });
    if(selectedIdx.length===0){ alert('Select at least one symbol.'); return; }
    const delay=(ms)=>new Promise(r=>setTimeout(r,ms));
    for(let k=0;k<selectedIdx.length;k++){
      await window.fetchOneWatch(selectedIdx[k]);
      // Alpha Vantage free tier rate limits are commonly low; wait longer when AV is involved.
      const provider=state.data.provider; const usingAV=(provider==='AV') || (provider==='AUTO' && state.data.avKey);
      await delay(usingAV ? 15000 : 3000);
    }
  }

  // ---------- Export / Import / Reset ----------
  window.exportData = function(){
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pa_trader_equity_auto_backup.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  document.getElementById('import-file').addEventListener('change', (e)=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=(ev)=>{
      try{
        const obj=JSON.parse(ev.target.result);
        if(!obj || typeof obj!=='object') throw new Error('Invalid file');
        if(!('trades' in obj) || !('capital' in obj)) throw new Error('Missing keys');
        state = deepMerge(obj, DEFAULTS); save({rerender:true}); alert('Import successful.');
      }catch(err){ alert('Import failed: '+err.message); }
    };
    reader.readAsText(file);
  });
  window.resetAll = function(){ if(confirm('This will erase all positions & settings. Continue?')){ state = JSON.parse(JSON.stringify(DEFAULTS)); save({rerender:true}); alert('All data cleared.'); } }

  // ---------- Initial render ----------
  function renderAll(){
    // preserve current tab
    renderChecklist();
    renderSettings();
    renderTrades();
    renderKPIs();
    renderDataSettings();
    go(activeTabId);
  }
  // initial mount
  renderAll();
  go('dashboard');
})();
</script>
</body>
</html>